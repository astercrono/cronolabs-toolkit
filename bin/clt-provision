#!/usr/bin/env bash

subcommands=("fedora")

SUBCOMMAND="$1"
GROUP="all"

if [[ ! " ${subcommands[@]} " =~ " $SUBCOMMAND" ]] || [ -z "$SUBCOMMAND" ]; then
	echo "Invalid system type: $SUBCOMMAND"
	exit 1
fi


while getopts "g:" opt; do
        case "${opt}" in
        e) GROUP="${OPTARG}" ;;
        esac
done
shift $((OPTIND - 1))



sudo -v

#function dnf_update() {
#	echo "sudo dnf update -y"
#}

#function dnf_install() {
#	echo "sudo dnf install -y $@"
#}

#function dnf_copr_enable() {
#	echo ""
#}

function install_from_file_single() {
	filename="$1"
	shift
	while IFS= read -r line; do
		IFS=':'
		read -ra split <<< "$line"

		install_group=${split[0]}
		install_package=${split[1]}

		if [[ "$GROUP" != "all" ]] && [[ "$GROUP" != "$install_group" ]]; then
			continue
		fi

		# echo "Group = $install_group, Install Package = $install_package"
		# echo "$INSTALL_CMD $@ $install_package"
		echo "$@ $install_package" # TODO: flip to eval

	done < "$CLT_BIN/$filename"
}

function install_from_file_batch() {
	filename="$1"
	shift

	install_batch=()
	while IFS= read -r line; do
		IFS=':'
		read -ra split <<< "$line"

		install_group=${split[0]}
		install_package=${split[1]}

		if [[ "$GROUP" != "$install_group" ]]; then
			continue
		fi

		# echo "Group = $install_group, Install Package = $install_package"
		install_batch+=($install_package)
	done < "$CLT_BIN/$filename"

	# echo "Package Batch = ${install_batch[@]}"
	echo "$@ ${install_batch[@]}" # TODO: flip to eval
}

# TODO: flip commands from echo to eval
case $SUBCOMMAND in
fedora)
	echo "sudo dnf update -y"
	
	if [[ "$GROUP" == "workstation" ]]; then
		echo "sudo dnf copr enable @neurofedora/neurofedora-extra"
		echo "sudo dnf update -y"
	fi
	
	install_from_file_batch "dnf-list.txt" "sudo dnf install -y"

	if [[ "$GROUP" == "workstation" ]]; then
		echo "flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo"
		install_from_file_single "flatpak-list.txt" "flatpak install -y"
	fi

	;;
debian) 
	echo "Unsupported system type"
	;;
*) 
	echo "Unknown system type"
	;;
esac

